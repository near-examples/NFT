<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta charset="UTF-8">
        <link rel="stylesheet" href="https://unpkg.com/wasm-music@0.0.21/midisequencer/ui/pianorolldemo/styles.css" />
    </head>
    <body>
        <div id="toolbar">

            <button id="audiobutton" class="hiddenbutton" onclick="startAudio()" title="Start audio">&#128264;</button>
            <button id="playbutton" onclick="togglePlay()" title="Toggle play">&#9199;</button>
            <button id="recordingbutton" onclick="toggleRecording()" title="Toggle recording">&#x23fa;</button>

            <div id="currentMixOwner"></div>
            <div style="flex-grow: 1"></div>
            <button id="logginbutton" style="display: none;" onclick="login()">Login</button>
            
            <span id="loggedinuserspan" class="requireslogin"></span>
            <button id="logoutbutton" class="requireslogin" onclick="logout()">Logout</button>
            <button id="recordvideobutton" class="hiddenbutton">&#127909;</button>
        </div>        
        <div id="postingsarea">                        
            <div id="latest20mixes">

            </div>
        </div>
        
        <div id="controlsarea">
            <div style="display: flex; align-items: center;">
                <input id="tempoinput" type="number" value="120" min="20" max="300" /><label for="tempoinput">&nbsp;BPM</label>
                <select id="midipartselect"></select>
                <button id="addmidipartbutton">add</button>
                <div style="flex-grow: 1;"></div>                
                <button style="padding: 5px" class="requireslogin" id="postmixbutton" title="Publish to NEAR">Publish</button>
                <button id="savebutton" onclick="saveToLocalStorage()" title="Save to local storage">&#128190;</button>
                <button id="clearallbutton" onclick="clearAll()" title="Clear all">&#128465;</button>
            </div>
            <input id="timeindicator" style="width: 100%" type="range" value="0" min="0" max="22000"
                                oninput="seek(this.value)" />
        </div>
        <div id="container">            
            <div id="pianorolls"></div>
            <div id="mixerandpartscheduler">
                <midi-mixer oninput="mixerchange(event)" data-channels="piano,strings,drums,guitar,bass,flute"></midi-mixer>
                <midi-part-scheduler></midi-part-scheduler>
            </div>
        </div>
        <div style="height: 80px;"></div>
        <div id="copyright">
            Copyright (c) 2021 Peter Salomonsen 
        </div>    
        <script src="https://cdn.jsdelivr.net/gh/nearprotocol/near-api-js/dist/near-api-js.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bn.js"></script>
        <script type="module">
            import{gzip as e,ungzip as t}from"https://unpkg.com/pako@2.0.3/dist/pako.esm.mjs";const n=["KeyZ","KeyS","KeyX","KeyD","KeyC","KeyV","KeyG","KeyB","KeyH","KeyN","KeyJ","KeyM","Comma","KeyL","Period","Semicolon","Slash"],o=["KeyQ","Digit2","KeyW","Digit3","KeyE","KeyR","Digit5","KeyT","Digit6","KeyY","Digit7","KeyU","KeyI","Digit9","KeyO","Digit0","KeyP","BracketLeft"],a=new Array(88).fill(null).map(((e,t)=>["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"][t%12]+""+Math.floor((t+9)/12))).filter(((e,t)=>e)).reverse();function i(e){return 88-(e-21)}function s(e){return 88-e+21}customElements.define("midi-pianoroll",class extends HTMLElement{static get observedAttributes(){return["data-columns","data-title"]}constructor(){var e;super(),this.lastDuration=8,this.lastVelocity=100,this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=`\n<style>\n    :host {\n        display: inline-block;\n        background-color: rgba(0,0,0,0.0);\n        font-family: monospace;\n        font-size: 30px;\n        user-select: none;\n        -webkit-user-select: none;\n    }\n    #container {\n        width: 100%;\n        height: 100%;\n        display: flex;\n        flex-direction: column;\n    }\n    #pianorollcontainer {\n        overflow: auto;\n        display: flex;\n    }\n    #gridcontainer {\n        height: ${16*(e=88)}px;\n    }\n    #grid {\n        background:   \n            linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 15px, #258 15px),\n            linear-gradient(90deg, rgb(0,0,0) 0%, rgb(0,0,0) 127px, #3ac 127px);\n        background-size: 128px 16px;\n        grid-template-rows: repeat(${e}, 1fr);    \n        display: grid;\n        flex-grow: 1;\n        height: ${16*e}px;\n        user-select: none;\n    }\n    .note {\n        border: white solid 1px;\n        position: relative;\n    }\n    .note:hover {\n        box-shadow: 0px 0px 5px 5px rgba(255, 50, 0, 0.7);\n    }\n    #toolbar {\n        background-color: #358;\n        padding: 15px;\n        color: white;\n        border-top-left-radius: 30px;\n        border-top-right-radius: 30px;\n        display: flex;\n        align-items: center;\n        overflow-x: scroll;\n        overflow-y: hidden;\n    }\n    #titlespan {\n        white-space: nowrap;\n    }\n    #footer {\n        background-color: #358;\n        padding: 15px;\n        color: white;\n        border-bottom-left-radius: 30px;\n        border-bottom-right-radius: 30px;\n    }\n    #toolbar input[name=editmode] {\n        opacity: 0;\n        width: 0;\n        height: 0;\n    }\n    #toolbar label {\n        padding: 10px;\n    }\n    #toolbar input[type=radio]:checked + label {\n        background-color: rgba(0,0,0,0.3);\n    }\n    #toolbar input[type=checkbox]:checked + label {\n        background-color: rgba(0,0,0,0.3);\n    }\n    #timeIndicator {\n        grid-row-start: 1;\n        grid-row-end: 127;\n        background-color: rgba(255,255,255,0.3);\n        width: 2px;\n    }\n    #editcursor {\n        grid-row-start: 1;\n        grid-row-end: 127;\n        grid-column: 1 / 1;\n        background-color: rgba(0,255,255,0.3);\n        display: none;\n    }\n    #notenames {\n        position: sticky;\n        left: 0px;\n        color: white;\n        font-size: 14px;\n        z-index: 1;\n        margin-top: 20px\n    }\n    .notename {\n        padding-left: 2px;\n        height: 16px;\n        color: black;\n        background-color: white;\n        border-right: solid white 8px;\n        border-left: solid white 5px;\n        cursor: pointer;\n    }\n    .notename:active {\n        background-color: #bbb;\n        border-color: #ddd;\n    }\n    .sharp {\n        color: white;\n        background-color: black;\n        border-left: solid black 5px;\n    }\n    .velocityInput{\n        width: 55px;\n        position: absolute;\n        font-size: 16px;\n        top: 20px;\n    }\n    #ruler {\n        position: sticky;\n        top: 0;\n        display: grid;\n        background:   \n            linear-gradient(90deg, #222 0%, #222 127px, #447 127px);\n        background-size: 128px 20px;\n        height: 20px;\n        width: 100%;\n        font-size: 18px;\n        font-weight: 100;\n        color: #ddd;\n    }\n    #controllers {\n        position: sticky;\n        bottom: 0px;\n        background:   \n            linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 31px, #447 31px),\n            linear-gradient(90deg, #222 0%, #222 127px, #447 127px);\n        background-size: 128px 32px;\n        width: 100%;\n        height: 128px;\n        display: none;\n        grid-template-rows: 128px;\n        align-items: end;\n    }\n    .controllervalue {\n        height: 100%;\n        grid-row: 1 / 1;\n        display: grid;\n        align-items: end;\n    }\n    .controllervalue div {\n        background-color: white;\n    }\n    .controllervalue:hover {\n        box-shadow: 0px 0px 3px 3px rgba(255, 50, 0, 0.7);\n    }\n    input[type=checkbox] {\n        display: none;\n    }\n    #toolbar div {\n        font-size: 12px;        \n    }\n    #toolbar * {\n        margin: 3px;\n    }\n    #beatlengthinput {\n        width: 50px;\n    }\n</style>\n<div id="container">\n    <div id="toolbar">\n        <input type="radio" id="editmode_draw" name="editmode" value="draw" checked /><label for="editmode_draw" title="Draw">&#9998</label>\n        <input type="radio" id="editmode_erase" name="editmode" value="erase" /><label for="editmode_erase" title="Erase">&#8999;</label>\n        <select id="controllerselect">\n            <option value="">- select controller -</option>\n            <option value="7">Volume</option>\n            <option value="10">Pan</option>\n            <option value="64">Sustain</option>\n            <option value="91">Reverb</option>\n        </select>\n        <div>\n            Beats<br />\n            <input id="beatlengthinput" type="number" value="4" min="3" max="32" />\n        </div>\n        <select id="snapselect">\n            <option value="">- snap -</option>\n            <option value="4">1/1</option>\n            <option value="2">1/2</option>\n            <option value="1">1/4</option>\n            <option value="0.5">1/8</option>\n            <option value="0.25">1/16</option>\n            <option value="0.125">1/32</option>\n        </select>\n        <input type="checkbox" id="keyboardeditingenabledcheckbox"><label for="keyboardeditingenabledcheckbox" title="Keyboard editing">&#9000;</label>\n        <span id="titlespan"></span>\n        <span style="flex-grow: 1"></span>\n        <button id="clearcontentsbutton" onclick="clearContents()" title="Clear contents">&#128465;</button>\n    </div>\n    <div id="pianorollcontainer" tabindex="1">\n        <div id="notenames"></div>\n        <div id="gridcontainer">\n            <div id="ruler">\n            </div>\n            <div id="grid"></div>\n            <div id="controllers">\n            </div>\n        </div>\n        \n    </div>\n    <div id="footer">\n    </div>\n</div>\n`,this.gridcontainer=this.shadowRoot.getElementById("gridcontainer"),this.pianorollcontainer=this.shadowRoot.getElementById("pianorollcontainer"),this.grid=this.shadowRoot.getElementById("grid"),this.beatlengthinput=this.shadowRoot.querySelector("#beatlengthinput"),this.grid.addEventListener("click",(e=>{if("draw"===this.getEditMode()){if(this.existingNoteClicked){if(!this.hasMovedWhileDown){this.velocityInput&&this.velocityInput.parentElement.removeChild(this.velocityInput);const e=this.existingNoteClicked,t=document.createElement("input");t.classList.add("velocityinput"),t.onmousedown=e=>e.stopPropagation(),t.onclick=e=>e.stopPropagation(),t.type="number",t.max=127,t.min=1,t.value=e.velocityValue,t.oninput=()=>{let n=parseInt(t.value);n>127?n=127:n<1&&(n=1),this.lastVelocity=n,e.velocityValue=n,e.style.backgroundColor=`rgba(255,255,255,${n/127})`},t.onkeydown=e=>{"Escape"!==e.code&&"Tab"!==e.code||(this.velocityInput.blur(),e.preventDefault()),e.stopPropagation()},t.onblur=e=>{t.remove(),this.velocityInput=null},e.appendChild(t),this.velocityInput=t,t.focus(),t.select()}}else{const t=this.offsetYToNoteNumber(e.pageY-this.grid.offsetTop+this.pianorollcontainer.scrollTop);let n=this.offsetXToTimePosition(e.offsetX);this.snap&&(n=1+Math.floor((n-1)/(8*this.snap))*(8*this.snap)),this.addNoteInternal(t,n,this.lastDuration),this.dispatchNoteOn(t),setTimeout((()=>this.dispatchNoteOff(t)),500)}this.existingNoteClicked=null,this.hasMovedWhileDown=!1}}));const t=document.createElement("div");t.id="timeIndicator",this.grid.appendChild(t),this.timeIndicator=t;const s=this.shadowRoot.getElementById("notenames");a.forEach(((e,t)=>{const n=document.createElement("div");n.classList.add("notename"),"#"===e.charAt(1)&&n.classList.add("sharp"),n.addEventListener("mousedown",(()=>this.dispatchNoteOn(t+1))),n.addEventListener("mouseup",(()=>this.dispatchNoteOff(t+1))),n.addEventListener("mouseleave",(()=>this.dispatchNoteOff(t+1))),n.innerHTML=e,n.tabIndex=1e3+t,s.appendChild(n)}));const r=document.createElement("div");r.id="editcursor",r.setPosition=e=>{if(this.snap){e-=(e-1)%(8*this.snap),r.style.gridColumnStart=e,r.style.gridColumnEnd=e+8*this.snap}},this.grid.appendChild(r);const l=e=>{const t=parseInt(r.style.gridColumnStart),a=8*this.snap;if(this.snap&&"ArrowLeft"===e.code){if(e.shiftKey){const e=parseInt(r.style.gridColumnStart),t=parseInt(r.style.gridColumnEnd);t>e+a&&(r.style.gridColumnEnd=t-a)}else if(t>a){const e=t-a;r.setPosition(e);const n=16*e;n<this.pianorollcontainer.scrollLeft&&(this.pianorollcontainer.scrollLeft=n)}e.preventDefault(),e.stopPropagation()}else if(this.snap&&"ArrowRight"===e.code&&t<this.dataset.columns-a){const t=parseInt(r.style.gridColumnEnd);e.shiftKey?r.style.gridColumnEnd=t+a:r.setPosition(t);const n=16*(t+2*a);n>=this.pianorollcontainer.scrollLeft+this.pianorollcontainer.offsetWidth&&(this.pianorollcontainer.scrollLeft=n-this.pianorollcontainer.offsetWidth),e.preventDefault(),e.stopPropagation()}else if(this.snap&&"Backspace"===e.code)Array.from(this.grid.querySelectorAll(".note")).filter((e=>parseInt(e.style.gridColumnStart)>=parseInt(r.style.gridColumnStart)&&parseInt(e.style.gridColumnStart)<parseInt(r.style.gridColumnEnd))).forEach((e=>e.remove())),this.dispatchChangeEvent(),e.preventDefault(),e.stopPropagation();else if(this.snap&&"Space"===e.code){const t=parseInt(r.style.gridColumnStart),n=parseInt(r.style.gridColumnEnd),o=n-t;Array.from(this.grid.querySelectorAll(".note")).filter((e=>parseInt(e.style.gridColumnStart)>=t&&parseInt(e.style.gridColumnStart)<n)).forEach((e=>{const t=parseInt(e.style.gridRowStart),n=parseInt(e.style.gridColumnStart)+o,a=parseInt(e.style.gridColumnEnd)-parseInt(e.style.gridColumnStart);this.addNoteInternal(t,n,a,e.velocityValue,!0)})),this.dispatchChangeEvent(),e.preventDefault(),e.stopPropagation()}else if(!e.repeat){const t=Math.floor((this.pianorollcontainer.scrollHeight-this.pianorollcontainer.scrollTop)/192),a=n.findIndex((t=>t===e.code));let l=-1;if(a>-1)l=12*t+a;else{const n=o.findIndex((t=>t===e.code));n>-1&&(l=12*(t+1)+n)}if(l>=0&&l<128){const t=parseInt(r.style.gridColumnStart),n=i(l);if(e.preventDefault(),e.stopPropagation(),this.shadowRoot.getElementById("keyboardeditingenabledcheckbox").checked&&this.snap){let o=Array.from(this.grid.querySelectorAll(".note")).find((e=>parseInt(e.style.gridColumnStart)===t&&parseInt(e.style.gridRowStart)===n));o||e.shiftKey?o&&e.shiftKey&&o.remove():this.addNoteInternal(n,t,this.lastDuration)}this.dispatchNoteOn(n),s.childNodes[n-1].focus(),document.addEventListener("keyup",(()=>{this.dispatchNoteOff(n),s.childNodes[n-1].blur(),document.removeEventListener("keyup",this)}))}}};this.editcursor=r,this.pianorollcontainer.addEventListener("mouseenter",(()=>{document.addEventListener("keydown",l)})),this.pianorollcontainer.addEventListener("mouseleave",(()=>{document.removeEventListener("keydown",l)}));const c=this.shadowRoot.getElementById("controllerselect");this.controllers=this.shadowRoot.querySelector("#controllers"),this.controllers.addEventListener("mousedown",(e=>{const t=e.offsetX,n=e.offsetY;if("draw"===this.getEditMode()){let e=this.offsetXToTimePosition(t);this.addControlEventInternal(parseInt(c.value),e,128-n)}})),this.controllers.addEventListener("mouseup",(e=>{this.dispatchChangeEvent()})),this.allcontrollerdivs=[],c.addEventListener("change",(e=>{if(!e.target.value)return void(this.controllers.style.display="none");this.controllers.style.display="grid";const t=parseInt(e.target.value);for(;this.controllers.hasChildNodes();)this.controllers.lastChild.remove();this.allcontrollerdivs.filter((e=>e.controllerNumber===t)).forEach((e=>this.controllers.appendChild(e)))})),this.beatlengthinput.addEventListener("input",(e=>{const t=8*this.beatlengthinput.value;this.dataset.columns=t})),this.shadowRoot.querySelector("#snapselect").addEventListener("change",(e=>{e.target.value?(this.snap=parseFloat(e.target.value),r.style.display="block",r.setPosition(parseInt(r.style.gridColumnStart?r.style.gridColumnStart:1)),this.pianorollcontainer.focus()):(this.snap=null,r.style.display="none")})),this.shadowRoot.querySelector("#clearcontentsbutton").addEventListener("click",(()=>this.clearAll()))}attributeChangedCallback(e,t,n){switch(e){case"data-columns":const e=parseInt(n);this.grid.style.gridTemplateColumns=`repeat(${e}, 16px)`,this.controllers.style.gridTemplateColumns=`repeat(${e}, 16px)`,this.configureRuler(e),this.beatlengthinput.value=e/8;break;case"data-title":this.shadowRoot.getElementById("titlespan").innerHTML=n}}configureRuler(e){const t=this.shadowRoot.querySelector("#ruler");t.style.gridTemplateColumns=`repeat(${e}, 16px)`,Array.from(t.childNodes).forEach((e=>e.remove()));for(let n=0;n<e;n++){const e=document.createElement("div");n%8==0&&(e.innerHTML=n/8+""),t.appendChild(e)}}dispatchNoteOn(e){this.dispatchEvent(new CustomEvent("pianokey",{detail:{note:s(e),velocity:100}}))}dispatchNoteOff(e){this.dispatchEvent(new CustomEvent("pianokey",{detail:{note:s(e),velocity:0}}))}dispatchChangeEvent(){this.dispatchEvent(new CustomEvent("change",{detail:{}}))}setTimeIndicatorPos(e){e=Math.floor(8*e)+1,this.timeIndicator.style.gridColumnStart=e,this.timeIndicator.style.gridColumnEnd=e}offsetXToTimePosition(e){return Math.floor(e/16)+1}offsetYToNoteNumber(e){return Math.floor(e/16)+1}clearAll(){Array.from(this.shadowRoot.querySelectorAll(".note")).map((e=>e.remove())),this.allcontrollerdivs.forEach((e=>e.remove())),this.allcontrollerdivs=[],this.dispatchChangeEvent()}getEditMode(){return this.shadowRoot.querySelector("input[name=editmode]:checked").value}addControlEvent(e,t,n){this.addControlEventInternal(e,Math.round(8*t)+1,n)}addControlEventInternal(e,t,n){const o=document.createElement("div"),a=document.createElement("div");a.style.height=`${n+1}px`,o.appendChild(a),o.style.gridColumnStart=t,o.style.gridColumnEnd=t,o.controllerNumber=e,o.classList.add("controllervalue"),this.controllers.appendChild(o),this.allcontrollerdivs.push(o);const i=e=>{if("erase"===this.getEditMode()||e.shiftKey)o.remove(),this.allcontrollerdivs=this.allcontrollerdivs.filter((e=>e!==o)),this.pianorollcontainer.focus();else{const t=e.pageY-this.controllers.offsetTop+this.pianorollcontainer.scrollTop;a.style.height=128-t+1+"px"}e.stopPropagation(),e.preventDefault()};o.addEventListener("mousedown",(e=>i(e))),o.addEventListener("mousemove",(e=>{e.buttons&&i(e)}))}addNote(e,t,n,o){this.addNoteInternal(i(e),Math.round(8*t)+1,Math.round(8*n),o,!1)}addNoteInternal(e,t,n,o=this.lastVelocity,a=!0){const i=document.createElement("div");i.velocityValue=o,i.style.backgroundColor=`rgba(255,255,255,${i.velocityValue/127})`,i.classList.add("note");const s=()=>{i.style.gridColumnStart=t,i.style.gridColumnEnd=t+n,i.style.gridRowStart=e,i.style.gridRowEnd=e};s(),this.grid.appendChild(i),a&&(this.dispatchChangeEvent(),this.editcursor.setPosition(t)),i.addEventListener("mousedown",(o=>{if("erase"===this.getEditMode()||o.shiftKey)return this.grid.removeChild(i),void this.dispatchChangeEvent();const a=o.offsetX;let r=!1;a/16>=.6*n&&(r=!0),this.existingNoteClicked=i;const l=o=>{this.hasMovedWhileDown=!0;const i=o.pageX-this.gridcontainer.offsetLeft+this.pianorollcontainer.scrollLeft,l=o.pageY-this.grid.offsetTop+this.pianorollcontainer.scrollTop;r?((n=this.offsetXToTimePosition(i)-t)<0&&(n=1),this.snap&&0===(n=Math.round(n/(8*this.snap))*(8*this.snap))&&(n=8*this.snap),this.lastDuration=n):((t=this.offsetXToTimePosition(i-a))<1&&(t=1),this.snap&&(t=1+Math.round((t-1)/(8*this.snap))*(8*this.snap),this.editcursor.setPosition(t)),e=this.offsetYToNoteNumber(l)),s(),this.dispatchChangeEvent()};window.addEventListener("mousemove",l);const c=()=>{window.removeEventListener("mousemove",l),window.removeEventListener("mouseup",c)};window.addEventListener("mouseup",c)}))}getPianorollData(){return Array.from(this.shadowRoot.querySelectorAll(".note")).map((e=>({start:(parseInt(e.style.gridColumnStart)-1)/8,end:(parseInt(e.style.gridColumnEnd)-1)/8,noteNumber:127&s(parseInt(e.style.gridRowStart)),velocityValue:127&e.velocityValue}))).concat(this.allcontrollerdivs.map((e=>({start:(parseInt(e.style.gridColumnStart)-1)/8,controllerValue:parseInt(e.firstChild.style.height)-1&127,controllerNumber:127&e.controllerNumber}))))}});customElements.define("midi-mixer",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML='\n<style>\n  :host {\n    display: inline-block;\n    overflow-x: scroll;\n    max-height: 220px;\n  }\n  .panslider {\n    width: 50px;\n  }\n  .volumeslider {\n     appearance: slider-vertical;\n     -webkit-appearance: slider-vertical;\n  }\n  .mixerchannel {\n    display: flex;\n    text-align: center;\n    flex-direction: column;\n    width: 60px;\n    font-size: 11px;\n  }\n</style>\n<template id="mixerchanneltemplate">\n  <div class="mixerchannel">\n    <input class="panslider" \n           type="range" min=0 max=127 value=64>\n    <span class="panvaluespan">&nbsp;</span>\n    <input class="volumeslider" type="range" min=0 max=127 value=100 orient="vertical">\n    <span class="volumevaluespan">&nbsp;</span>\n    <span class="channelnamespan">&nbsp;</span>\n  </div>\n</template>\n<div style="display: flex" id="mixerchannels">\n</div>\n',this.init()}init(){const e=this.shadowRoot.querySelector("#mixerchanneltemplate"),t=this.dataset.channels?this.dataset.channels.split(","):new Array(16).fill("").map(((e,t)=>`ch ${t}`));for(let n=0;n<16;n++){const o=e.content.cloneNode(!0);this.shadowRoot.querySelector("#mixerchannels").appendChild(o),this.shadowRoot.querySelectorAll(".channelnamespan")[n].innerHTML=t[n];const a=this.shadowRoot.querySelectorAll(".volumeslider")[n];a.addEventListener("input",(e=>{e.stopPropagation(),this.shadowRoot.querySelectorAll(".volumevaluespan")[n].innerHTML=a.value,this.oninput(new CustomEvent("midimixerevent",{detail:{channel:n,controller:7,value:parseInt(a.value)}}))}));const i=this.shadowRoot.querySelectorAll(".panslider")[n];i.addEventListener("input",(e=>{e.stopPropagation(),this.shadowRoot.querySelectorAll(".panvaluespan")[n].innerHTML=i.value,this.oninput(new CustomEvent("midimixerevent",{detail:{channel:n,controller:10,value:parseInt(i.value)}}))})),t[n]||(this.shadowRoot.querySelectorAll(".mixerchannel")[n].style.display="none")}}setVolume(e,t){const n=this.shadowRoot.querySelectorAll(".volumeslider")[e];n.value=t,n.dispatchEvent(new InputEvent("input"))}setPan(e,t){const n=this.shadowRoot.querySelectorAll(".panslider")[e];n.value=t,n.dispatchEvent(new InputEvent("input"))}getState(){const e=new Array(16),t=new Array(16);return this.shadowRoot.querySelectorAll(".panslider").forEach(((t,n)=>e[n]=t.value)),this.shadowRoot.querySelectorAll(".volumeslider").forEach(((e,n)=>t[n]=e.value)),new Array(16).fill(null).map(((n,o)=>({pan:e[o],volume:t[o]})))}});customElements.define("midi-part-scheduler",class extends HTMLElement{static get observedAttributes(){return["data-parts"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML='\n    <style>\n        :host {\n            height: inherit;\n        }\n        input {\n            width: 40px;\n        }\n        #tablediv {\n            max-height: 90%;\n            overflow: scroll;\n        }\n    </style>\n    <template id="partschedulerowtemplate">\n        <tr>\n            <td><input class="beatinput" min="0" type="number" onchange="getRootNode().notifyChange()" /></td>\n            <td>\n                <select class="partselect" onchange="getRootNode().notifyChange()"></select>\n            </td>\n            <td><input class="repeatinput" type="number" value="1" onchange="getRootNode().notifyChange()" /></td>\n            <td><button onclick="this.closest(\'tr\').remove()">&#128465;</button></td>\n        </tr>\n    </template>\n    <div id="tablediv">\n        <table id="partscheduletable">\n            <thead>\n                <tr>\n                    <th>beat</th>\n                    <th>part</th>\n                    <th>repeat</th>\n                </tr>\n            </thead>\n            <tbody>\n                \n            </tbody>\n        </table>\n    </div>\n    <button id="addbutton">add</button>\n',this.scheduletablebody=this.shadowRoot.querySelector("#partscheduletable tbody"),this.shadowRoot.getElementById("addbutton").addEventListener("click",(()=>{this.addRow("",0,"");const e=this.shadowRoot.querySelector("#tablediv");e.scrollTop=e.scrollHeight})),this.shadowRoot.notifyChange=()=>this.notifyChange()}addRow(e,t,n){const o=this.shadowRoot.getElementById("partschedulerowtemplate"),a=document.importNode(o.content,!0);a.querySelector(".partselect").innerHTML=this.parts.map(((e,t)=>`<option value="${t}">${e}</option>`)),a.querySelector(".beatinput").value=e,a.querySelector(".partselect").value=t,a.querySelector(".repeatinput").value=n,this.scheduletablebody.appendChild(a),this.notifyChange()}attributeChangedCallback(e,t,n){switch(e){case"data-parts":this.parts=n.split(","),Array.from(this.shadowRoot.querySelectorAll(".partselect")).forEach((e=>{const t=e.value;e.innerHTML=this.parts.map(((e,t)=>`<option value="${t}">${e}</option>`)),e.value=t}))}}notifyChange(){Array.from(this.scheduletablebody.children).sort(((e,t)=>parseInt(e.querySelector(".beatinput").value)-parseInt(t.querySelector(".beatinput").value))).forEach(((e,t)=>{const n=this.scheduletablebody.children[t];n&&n!==e?this.scheduletablebody.replaceChild(e,n):n||this.scheduletablebody.appendChild(e)})),this.dispatchEvent(new CustomEvent("change"))}getState(){return Array.from(this.scheduletablebody.children).map((e=>{const t=parseInt(e.querySelector(".repeatinput").value);return{beat:parseInt(e.querySelector(".beatinput").value),part:parseInt(e.querySelector(".partselect").value),repeat:isNaN(t)?0:t}})).filter((e=>!isNaN(e.beat)))}setState(e){for(;this.scheduletablebody.children.length>0;)this.scheduletablebody.firstChild.remove();e.forEach((e=>{this.addRow(e.beat,e.part,e.repeat)}))}});class r{constructor(e){this.workerMessageListeners=[],this.messagePort=e,e.onmessage=e=>{this.workerMessageListeners=this.workerMessageListeners.filter((t=>!0===t(e)))},e.onmessageerror=e=>{console.error(e)}}async callAndGetResult(e,t){return await new Promise((n=>{this.workerMessageListeners.push((e=>!t(e.data)||n(e.data))),this.messagePort.postMessage(e)}))}}new Array(128).fill(null).map(((e,t)=>["c","cs","d","ds","e","f","fs","g","gs","a","as","b"][t%12]+""+Math.floor(t/12)));let l,c,d;window.showCamViewer=function(){const e=document.createElement("video");e.autoplay=!0,e.style.position="fixed",e.style.right="5px",e.style.bottom="5px",e.style.width="250px",e.style.height="250px",e.style.zIndex=9999999,document.documentElement.appendChild(e),navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0}).then((function(t){e.srcObject=t})).catch((function(e){console.error(e)}))};function u(e){e?document.documentElement.appendChild(document.createElement("progress-spinner")):document.getElementsByTagName("progress-spinner")[0].remove()}customElements.define("progress-spinner",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML='<style type="text/css">\n:host {\n    position: fixed;\n    left: 0px;\n    top: 0px;\n    width: 100%;\n    height: 100%;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    z-index: 100;\n    background-color: rgba(100, 100, 100, 0.5);\n}\n.loader {\n    border: 16px solid #f3f3f3;\n    /* Light grey */\n    border-top: 16px solid #3498db;\n    /* Blue */\n    border-radius: 50%;\n    width: 120px;\n    height: 120px;\n    animation: loaderspin 2s linear infinite;\n}\n#loaderprogress {\n    display: none;\n    position: inherit;\n    background-color: #444;\n    padding: 5px;\n    border-radius: 4px;\n}\n@keyframes loaderspin {\n    0% {\n        transform: rotate(0deg);\n    }\n\n    100% {\n        transform: rotate(360deg);\n    }\n}\n</style>\n<div id="loadercontainer">\n    <div class="loader"></div>\n    <div id="loaderprogress"></div>\n</div>'}});const p={nodeUrl:"https://rpc.mainnet.near.org",walletUrl:"https://wallet.mainnet.near.org",helperUrl:"https://helper.mainnet.near.org",networkId:"mainnet",contractName:"psalomo.near",deps:{keyStore:null}};let h=null,m=null;async function g(){await walletConnection.requestSignIn(p.contractName,"wasm-music"),await loadAccountData()}function y(e){const t=1e3*e;return new BN(10,10).pow(new BN(21,10)).mul(new BN(t,10)).toString()}async function f(e){return await walletConnection.account().viewFunction(p.contractName,"view_remix_content",{token_id:e})}async function v(e="7"){return h=await walletConnection.account().viewFunction(p.contractName,"view_price",{token_id:e}),h}async function w(e="7"){return m=await walletConnection.account().viewFunction(p.contractName,"get_token_owner",{token_id:e}),m}async function b(e){return await new Promise((t=>{const n=new FileReader;n.onload=()=>t(n.result.split("base64,")[1]),n.readAsDataURL(new Blob([e]))}))}async function x(){await async function(){p.deps.keyStore=new nearApi.keyStores.BrowserLocalStorageKeyStore,window.near=await nearApi.connect(p);const e=new nearApi.WalletConnection(near);window.walletConnection=e,e.getAccountId()?(document.getElementById("loggedinuserspan").innerHTML=e.getAccountId(),document.getElementById("logoutbutton").style.display="block"):console.log("no loggedin user")}(),walletConnection.getAccountId()?document.querySelectorAll(".requireslogin").forEach((e=>e.style.display="block")):document.getElementById("logginbutton").style.display="block"}window.login=g,window.logout=async function(){await walletConnection.signOut(),location.reload()},window.buyNFT=async function(e="7",t=h){u(!0);try{walletConnection.getAccountId()||g();const n=await walletConnection.account().functionCall(p.contractName,"buy_token",{token_id:e},"100000000000000",t);console.log("succeeded buying",n)}catch(e){alert(e.message)}u(!1)},window.sellNFT=async function(e,t="7"){if(u(!0),console.log("selling for",y(e)),e){const n=await walletConnection.account().functionCall(p.contractName,"sell_token",{token_id:t,price:y(e)});console.log("token is now for sale",n),alert("token is now for sale")}else await walletConnection.account().functionCall(p.contractName,"remove_token_from_sale",{token_id:t}),alert("token is no longer for sale");u(!1),location.reload()};function E(e,t){e.forEach((e=>{e.noteNumber?t.addNote(e.noteNumber,e.start,e.duration,e.velocityValue):t.addControlEvent(e.controllerNumber,e.start,e.controllerValue)}))}async function k(e){const t=document.createElement("common-modal");t.shadowRoot.innerHTML=`<style>\n    :host {\n        position: fixed;\n        display: flex;\n        top:0;\n        bottom: 0;\n        left: 0;\n        right: 0;\n        margin: auto;\n        z-index: 1000;\n        background-color: rgba(255, 255, 255, 0.7);\n    }\n    .modaldiv {\n        margin: auto;\n        text-align: center;\n        padding: 20px;\n        background-color: rgba(0, 0, 0, 0.8);\n        border: #4a4 solid 5px;\n        color: #4a4;\n        font-family: monospace;\n        font-size: 20px;\n        max-width: 800px;\n        border-radius: 50px;\n    }\n    button, textarea {\n        font-family: monospace;\n        background-color: #cfc;\n        border-color: #4a4;\n        border-width: 1px;\n        color:#050;\n        padding: 10px;\n        font-size: 20px;\n        \n        border-radius: 4px;\n        white-space: nowrap;\n        \n        margin: 2px;\n        user-select: none;\n    }\n    textarea {\n        width: 80%;\n        height: 80px;\n    }\n</style>\n<div class="modaldiv">\n    ${e}\n</div>`,document.documentElement.appendChild(t);const n=await t.resultPromise;return document.documentElement.removeChild(t),n}async function C(e,t){return k(`\n    <h3>${e}</h3>\n    <p>${t}</p>\n    <p>\n        <button onclick="getRootNode().result(false)">No</button>\n        <button onclick="getRootNode().result(true)">Yes</button>\n    </p>`)}customElements.define("common-modal",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.resultPromise=new Promise((e=>this.shadowRoot.result=e))}});const S=document.querySelector("#currentMixOwner");function I(e){return t=atob(e),new Uint8Array(t.length).map(((e,n)=>t.charCodeAt(n)));var t}function A(e){try{const n=I(e);return t(n)}catch(e){return null}}function q(){const e=Array.from(document.querySelectorAll("midi-pianoroll")).map((e=>({channel:e.channel,length:e.dataset.columns/8,pianorolldata:e.getPianorollData()}))),t=function(e){const t=e.map((e=>{const t=e.pianorolldata,n=t.filter((e=>e.noteNumber)).length,o=t.length-n;return[e.channel,n,o].concat(t.map((e=>e.noteNumber?[8*e.start,8*(e.end-e.start),e.noteNumber,e.velocityValue]:[8*e.start,e.controllerNumber,e.controllerValue])))})).flat(2);return new Uint8Array(t)}(e),n=document.getElementsByTagName("midi-part-scheduler")[0].getState(),o=new Uint8Array(1+t.length+32+2+1+3*n.length+e.length);o[0]=e.length,o.set(t,1);const a=document.querySelector("midi-mixer").getState();let i=t.length+1;return a.forEach((e=>{o[i++]=e.volume,o[i++]=e.pan})),o[i++]=parseInt(document.getElementById("tempoinput").value),i++,o[i++]=n.length,n.forEach((e=>{o[i++]=e.beat,o[i++]=e.part,o[i++]=e.repeat})),e.forEach((e=>o[i++]=e.length)),o}function N(e){oe();let t=6;e[0]>0&&(t=e[0],e=e.slice(1));const{pianorollsdata:n,deserializedbytecount:o}=function(e,t){const n=new Array;let o=0;for(;n.length<t;){const t=e[o],a=e[o+1],i=e[o+2],s=[];o+=3;const r=o+4*a,l=r+3*i;for(;o<r;){const t=e[o++]/8,n=e[o++]/8,a=e[o++],i=e[o++];s.push({start:t,duration:n,noteNumber:a,velocityValue:i})}for(;o<l;){const t=e[o++]/8,n=e[o++],a=e[o++];s.push({start:t,controllerNumber:n,controllerValue:a})}n.push({channel:t,pianorolldata:s})}return{pianorollsdata:n,deserializedbytecount:o}}(e,t),a=[];for(let e=0;e<t;e++){const t=Q(n[e].channel);E(n[e].pianorolldata,t),a.push(t)}const i=document.querySelector("midi-mixer"),s=o;e.slice(s,s+32).forEach(((e,t)=>{const n=Math.floor(t/2);t%2==0?i.setVolume(n,e):i.setPan(n,e)}));const r=document.getElementById("tempoinput");r.value=e[s+32];const l=e[s+33];r.dispatchEvent(new Event("change"));const c=document.querySelector("midi-part-scheduler");if(e.length>s+34){let t=e[s+34],n=s+35;const o=[];for(var d=0;d<t;d++)o.push({beat:e[n++],part:e[n++],repeat:e[n++]});c.setState(o);let i=n;a.forEach((t=>{t.dataset.columns=8*e[i++]}))}else c.setAttribute("data-parts",a.map((e=>e.dataset.title)).join(",")),c.setState([{part:0,beat:0,repeat:0},{part:1,beat:0,repeat:0},{part:2,beat:0,repeat:0},{part:3,beat:0,repeat:0},{part:4,beat:0,repeat:0},{part:5,beat:0,repeat:0}]),a.forEach(((e,t)=>{e.channel=t,e.dataset.columns=8*l}));ee(0)}function L(){document.querySelector("#savebutton").style.display="none",document.querySelector("#postmixbutton").style.display="none"}function R(e,t){t=t||{};var n=e.numberOfChannels,o=e.sampleRate,a=t.float32?3:1,i=3===a?32:16;return function(e,t,n,o,a){var i=a/8,s=o*i,r=new ArrayBuffer(44+e.length*i),l=new DataView(r);M(l,0,"RIFF"),l.setUint32(4,36+e.length*i,!0),M(l,8,"WAVE"),M(l,12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,t,!0),l.setUint16(22,o,!0),l.setUint32(24,n,!0),l.setUint32(28,n*s,!0),l.setUint16(32,s,!0),l.setUint16(34,a,!0),M(l,36,"data"),l.setUint32(40,e.length*i,!0),1===t?function(e,t,n){for(var o=0;o<n.length;o++,t+=2){var a=Math.max(-1,Math.min(1,n[o]));e.setInt16(t,a<0?32768*a:32767*a,!0)}}(l,44,e):function(e,t,n){for(var o=0;o<n.length;o++,t+=4)e.setFloat32(t,n[o],!0)}(l,44,e);return r}(2===n?function(e,t){var n=e.length+t.length,o=new Float32Array(n),a=0,i=0;for(;a<n;)o[a++]=e[i],o[a++]=t[i],i++;return o}(e.getChannelData(0),e.getChannelData(1)):e.getChannelData(0),a,o,n,i)}function M(e,t,n){for(var o=0;o<n.length;o++)e.setUint8(t+o,n.charCodeAt(o))}(async()=>{u(!0),await x();const t=(await async function(){return await walletConnection.account().viewFunction(p.contractName,"get_token_mixes",{token_id:"7"})}()).map((e=>e.split(";")));u(!1);const n=t.filter((e=>-1===e[1].indexOf("nft:"))).sort(((e,t)=>parseInt(t[1])-parseInt(e[1]))).map((e=>({content:A(e[2]),timestamp:e[1],author:e[0],identitfier:e.join(";")}))),o=t.filter((e=>0===e[1].indexOf("nft:")));let a;const i=document.getElementById("latest20mixes");document.querySelectorAll(".patternelement");const s=e=>{const t=document.createElement("div");t.style.display="grid",t.style.gridTemplateColumns="auto auto";const n=document.createElement("div");n.classList.add("mixlistitem");const o=e.content;n.onclick=async()=>{if(L(),a&&a.classList.remove("currentmix"),a=n,n.classList.add("currentmix"),N(o),ne(),e.owner){let t="";if(e.owner===walletConnection.account().accountId){t+="owner: you";try{const n=await v(e.token_id),o=nearApi.utils.format.formatNearAmount(n);t+=`. on sale for ${o}N\n                            <button onclick="sellNFT(prompt('Sell for what price?','${o}'), '${e.token_id}')">Change</button>\n                        `}catch(n){t+=`<button onclick="sellNFT(prompt('Sell for what price?','10'), '${e.token_id}')">Sell</button>`}t+='<button id="exportwavbutton" title="download">&#11015;</button>'}else{t+=`owner: ${e.owner} `;try{const n=await v(e.token_id),o=nearApi.utils.format.formatNearAmount(n);t+=`<button onclick="buyNFT('${e.token_id}','${n}')">Buy ${o}N</button>`}catch(e){console.error(e)}}S.innerHTML=t,S.style.display="block";const n=document.getElementById("exportwavbutton");n&&n.addEventListener("click",(()=>ie()))}else S.innerHTML="No owner. <button>Buy 10N</button>",S.querySelector("button").onclick=()=>async function(e){walletConnection.getAccountId()?(u(!0),await walletConnection.account().functionCall(p.contractName,"buy_mix",{original_token_id:"7",mix:e},3e14,nearApi.utils.format.parseNearAmount("10")),u(!1)):alert("Please log in first")}(e.identitfier),S.style.display="block"},n.innerHTML=`author: ${e.author}<br />\n                <span class="mixlistdate">${new Date(parseInt(e.timestamp)/1e6).toLocaleString()}</span><br />\n                ${e.owner?`owner: ${e.owner}`:"no owner"}`,t.appendChild(n),i.appendChild(t)};if(n.forEach((e=>s(e))),o.length>0){(await Promise.all(o.map((e=>({token_id:e[1].substr("nft:".length),author:e[0]}))).map((async e=>Object.assign(e,{owner:await w(e.token_id),content:await f(e.token_id)}))))).map((e=>Object.assign(e,{content:A(e.content.split(";")[3]),timestamp:e.content.split(";")[2]}))).forEach((e=>s(e)))}20===o.length&&L(),document.getElementById("postmixbutton").addEventListener("click",(async()=>{await C("Publish your track?",'\n            <ul style="text-align: left; font-size: 14px;">\n            <li>Your track will be listed on top of this page, and for sale for 10N</li>\n            <li>You will get 4N if sold ( the rest goes to the instrument NFT owner and platform )</li>\n            <li>The first owner will be able to export to wav, and can also resell for any price</li>\n            <li>You will get 2% on re-sales, the owner will get 95% when selling</li>\n            </ul>\n        ')&&async function(e){u(!0);const t=await b(e);await walletConnection.account().functionCall(p.contractName,"publish_token_mix_base64",{token_id:"7",mixbase64:t},3e14),u(!1),location.reload()}(e(q()))}))})();let T,P,B,D;function _(e){null!==e?(T||(T=document.createElement("progress-bar"),document.documentElement.appendChild(T)),T.setValue(e)):T&&(T.remove(),T=null)}function F(e){const t=e.toString(),n=t.substring(t.indexOf("{")+1,t.lastIndexOf("}"));return URL.createObjectURL(new Blob([n],{type:"text/javascript"}))}function O(){class e extends AudioWorkletProcessor{constructor(){super(),this.processorActive=!0,this.playMidiSequence=!0,AudioWorkletGlobalScope.midisequencer.currentFrame=0,this.port.onmessage=async e=>{e.data.wasm&&(this.wasmInstancePromise=WebAssembly.instantiate(e.data.wasm,{environment:{SAMPLERATE:e.data.samplerate},env:{abort:()=>console.log("webassembly synth abort, should not happen")}}),this.wasmInstance=(await this.wasmInstancePromise).instance.exports,AudioWorkletGlobalScope.midisequencer.addMidiReceiver(this.wasmInstance.shortmessage),this.port.postMessage({wasmloaded:!0})),e.data.sequencedata&&(this.allNotesOff(),AudioWorkletGlobalScope.midisequencer.setSequenceData(e.data.sequencedata)),void 0!==e.data.toggleSongPlay&&(this.playMidiSequence=e.data.toggleSongPlay,!1===e.data.toggleSongPlay&&this.allNotesOff()),e.data.midishortmsg&&((await this.wasmInstancePromise).instance.exports.shortmessage(e.data.midishortmsg[0],e.data.midishortmsg[1],e.data.midishortmsg[2]),AudioWorkletGlobalScope.midisequencer.onmidi(e.data.midishortmsg)),e.data.recorded&&this.port.postMessage({recorded:AudioWorkletGlobalScope.midisequencer.getRecorded()}),e.data.currentTime&&this.port.postMessage({currentTime:this.processorActive?AudioWorkletGlobalScope.midisequencer.getCurrentTime():null}),void 0!==e.data.seek&&(this.allNotesOff(),AudioWorkletGlobalScope.midisequencer.setCurrentTime(e.data.seek)),e.data.terminate&&(this.processorActive=!1,this.port.close())},this.port.start()}allNotesOff(){if(this.wasmInstance){this.wasmInstance.allNotesOff();for(let e=0;e<16;e++)this.wasmInstance.shortmessage(176+e,64,0)}}process(e,t,n){const o=t[0];return this.wasmInstance&&(this.playMidiSequence&&AudioWorkletGlobalScope.midisequencer.onprocess(),this.wasmInstance.fillSampleBuffer(),o[0].set(new Float32Array(this.wasmInstance.memory.buffer,this.wasmInstance.samplebuffer,128)),o[1].set(new Float32Array(this.wasmInstance.memory.buffer,this.wasmInstance.samplebuffer+512,128))),this.processorActive}}registerProcessor("asc-midisynth-audio-worklet-processor",e)}function $(){AudioWorkletGlobalScope.midisequencer=new class{constructor(){this.sequence=[],this.recorded={}}setSequenceData(e){e.length>0&&(this.recorded={});const t=e.find((e=>1===e.message.length&&-2===e.message[0]));if(t&&t.time<=this.getCurrentTime()?this.recordingActive=!0:this.recordingActive=!1,this.sequence.length>0&&e.length>0){const t=this.currentFrame/sampleRate*1e3;this.sequenceIndex=e.findIndex((e=>e.time>=t))}else this.sequenceIndex=0,this.currentFrame=0;this.sequence=e}addMidiReceiver(e){this.midireceiver=e}onmidi(e){this.recordingActive&&(this.recorded[this.currentFrame]||(this.recorded[this.currentFrame]=[]),this.recorded[this.currentFrame].push([e[0],e[1],e[2]]))}getRecorded(){return Object.keys(this.recorded).sort(((e,t)=>e-t)).reduce(((e,t)=>e.concat(this.recorded[t].map((e=>[t/sampleRate].concat(e))))),[])}getCurrentTime(){return this.currentFrame/sampleRate*1e3}setCurrentTime(e){this.currentFrame=sampleRate*e/1e3;let t=0;for(;t<this.sequence.length&&this.sequence[t]&&this.sequence[t].time<e;)t++;this.sequenceIndex=t}onprocess(){let e=this.getCurrentTime();for(;this.sequenceIndex<this.sequence.length&&this.sequence[this.sequenceIndex]&&this.sequence[this.sequenceIndex].time<e;){let t=!1;for(;this.sequence[this.sequenceIndex].message[0]<0&&this.sequence[this.sequenceIndex].time<=e;){switch(this.sequence[this.sequenceIndex].message[0]){case-1:t=!0;break;case-2:this.recordingActive=!0,this.sequenceIndex++;break;case-3:this.recordingActive=!1,this.sequenceIndex++}if(t)break}if(t){this.sequenceIndex=0,this.currentFrame=0;break}const n=this.sequence[this.sequenceIndex].message;this.midireceiver(n[0],n[1],n[2]),this.sequenceIndex++}if(this.recordingActive&&this.recorded[this.currentFrame]){const e=this.recorded[this.currentFrame];for(let t=0;t<e.length;t++){const n=e[t];this.midireceiver(n[0],n[1],n[2])}}this.currentFrame+=128}}}customElements.define("progress-bar",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML='\n<style type="text/css">\n:host {\n    position: fixed;\n    top:0;\n\tbottom: 0;\n\tleft: 0;\n\tright: 0;\n    font-family: monospace;\n    margin: auto;\n    z-index: 1000;\n    background-color: rgba(100, 100, 100, 0.5);\n}\n\n.progress-border {\n    position: fixed;\n    top:0;\n\tbottom: 0;\n\tleft: 0;\n\tright: 0;\n  \t\n    margin: auto;\n\n    border: green solid 1px;\n    height: 50px;\n    width: 100%;\n}\n\n.progress-text {\n    position: absolute;\n    color: white;\n    text-align: center;\n    width: 100%;\n    height: 100%;\n    font-size: 45px;\n}\n\n.progress-fill {\n    background-color: rgba(0,255,0, 0.7);\n    height: 50px;    \n}\n</style>\n<div id="main-progress-bar" class="progress-border">\n<div class="progress-text">50%</div>\n<div class="progress-fill" style="width:20%"></div>\n</div>\n'}setValue(e){this.shadowRoot.querySelector(".progress-text").innerHTML=`${(100*e).toFixed(0)}%`,this.shadowRoot.querySelector(".progress-fill").style.width=`${(100*e).toFixed(2)}%`}});let K,U=!1,H=!1,V=100;const W=document.querySelector("#pianorolls"),z=document.querySelector("#midipartselect"),G=document.querySelector("midi-part-scheduler");let j;const Y=["piano","strings","drums","guitar","bass","flute"];let X,J={};function Q(e){J[e]||(J[e]=1);const t=Y[e]+" "+J[e]++,n=document.createElement("midi-pianoroll");n.setAttribute("data-title",t),n.setAttribute("data-columns",32),n.style.display="none",n.channel=e,W.appendChild(n);const o=document.createElement("option");return o.value=W.childElementCount-1,o.innerHTML=t,z.appendChild(o),G.setAttribute("data-parts",Array.from(z.childNodes).map((e=>e.innerHTML))),n}const Z=e=>{P.port.postMessage({midishortmsg:[144+e.target.channel,e.detail.note,e.detail.velocity]})};function ee(e){X&&(X.style.display="none",X.removeEventListener("change",ne),X.removeEventListener("pianokey",Z)),document.querySelector("#midipartselect").value=e,X=W.childNodes[e],X.style.display="block",X.addEventListener("change",ne),X.addEventListener("pianokey",Z)}function te(){const e=Array.from(W.childNodes).map((e=>({channel:e.channel,length:parseInt(e.dataset.columns)/8,pianorolldata:e.getPianorollData()}))),t=e.map((e=>e.pianorolldata.map((t=>t.noteNumber?[{time:t.start,message:[144+e.channel,t.noteNumber,t.velocityValue]},{time:t.end-.01,message:[144+e.channel,t.noteNumber,0]}]:{time:t.start,message:[176+e.channel,t.controllerNumber,t.controllerValue]})).flat(1))),n=G.getState();let o=0;const a=n.map((n=>{const a=1+n.repeat,i=e[n.part].length,s=n.beat+i*a;s>o&&(o=s);const r=[];for(let e=0;e<a;e++)t[n.part].forEach((t=>r.push(Object.assign({},t,{time:6e4*(i*e+t.time+n.beat)/V}))));return r})).flat(1);return j=6e4*o/V,document.getElementById("timeindicator").max=j,a.sort(((e,t)=>e.time-t.time))}function ne(){if(!B)return;const e=te();H&&(e.splice(0,0,{time:0,message:[-2]}),e.push({time:j,message:[-3]})),e.push({time:j,message:[-1]}),P.port.postMessage({sequencedata:e})}function oe(){Array.from(document.querySelectorAll("midi-pianoroll")).forEach((e=>e.remove())),Array.from(z.childNodes).forEach((e=>e.remove())),document.querySelector("midi-part-scheduler").setState([]),J={},ne()}z.addEventListener("change",(e=>ee(e.target.value))),window.toggleRecording=async function(){if(H=!H,H)document.getElementById("recordingbutton").classList.add("toggled");else{document.getElementById("recordingbutton").classList.remove("toggled");const e=(await D.callAndGetResult({recorded:!0},(e=>void 0!==e.recorded))).recorded;if(await C("keep recording?","")){const t=G.getState().filter((e=>e.part==z.value));(function(e,t){return e.map((e=>[e[0],e[1],e[2],e[3]*t/60,e[1]<0?e[4]:e[4]*t/60]))})(function(e){const t=[],n={},o=e=>((15&e[0])<<8)+e[1];return e.forEach((e=>{const a=e[0],i=e.slice(1);if(144==(240&i[0])&&i[2]>0)n[o(i)]={startTime:a,velocity:i[2]};else if((128==(240&i[0])||144==(240&i[0])&&0===i[2])&&n[o(i)]){const e=o(i),s=n[e],r=s.startTime,l=a-r;delete n[e];const c=255&e,d=(3840&e)>>8;t.push([d,c,s.velocity,r,l])}else if(176==(240&i[0])){const e=15&i[0],n=i[1],o=i[2];t.push([e,-1,o,a,n])}})),t}(e),V).forEach((e=>{const n=e[3],o=(a=t.filter((e=>e.beat<n))).length?a[a.length-1].beat:-1;var a;if(o>=0){const t=n-o;e[1]>=0?X.addNote(e[1],t,e[4],e[2]):X.addControlEvent(e[4],t,e[2])}}))}}ne()},window.togglePlay=async function(){if(B||await startAudio(),U=!U,P.port.postMessage({toggleSongPlay:U}),U){document.querySelector("midi-mixer").getState().forEach(((e,t)=>{P.port.postMessage({midishortmsg:[176+t,7,e.volume]}),P.port.postMessage({midishortmsg:[176+t,10,e.pan]})})),ne(),document.getElementById("playbutton").classList.add("toggled")}else document.getElementById("playbutton").classList.remove("toggled")},window.startAudio=async function(){if(B)return;const e=document.getElementById("audiobutton");e.classList.add("toggled"),e.disabled=!0,B=new AudioContext({sampleRate:44100}),B.resume();const t=await async function(){try{return await walletConnection.account().viewFunction(p.contractName,"view_token_content_base64",{token_id:"7"})}catch(e){if(!(e.message.indexOf("requires payment")>-1))throw alert(e.message),u(!1),e;await walletConnection.account().functionCall(p.contractName,"request_listening",{token_id:"7"},void 0,null)}}();K=A(t),await B.audioWorklet.addModule(F($)),await B.audioWorklet.addModule(F(O)),P=new AudioWorkletNode(B,"asc-midisynth-audio-worklet-processor",{outputChannelCount:[2]}),P.port.start(),console.log("audioworklet node started"),D=new r(P.port),await D.callAndGetResult({samplerate:B.sampleRate,wasm:K,sequencedata:[],toggleSongPlay:!1},(e=>e.wasmloaded)),console.log("audioworklet node loaded"),P.connect(B.destination);try{const e=await navigator.requestMIDIAccess();for(var n of e.inputs.values())n.onmidimessage=e=>{const t=e.data;3!==t.length||128!=(240&t[0])&&144!=(240&t[0])&&176!=(240&t[0])||(t[0]=(255&t[0])+parseInt(W.childNodes[z.value].channel),P.port.postMessage({midishortmsg:t}))}}catch(e){console.log("no midi")}const o=async()=>{let e=(await D.callAndGetResult({currentTime:!0},(e=>void 0!==e.currentTime))).currentTime;const t=e*V/6e4,n=G.getState().filter((e=>e.part==z.value)),i=(s=n.filter((e=>e.beat<t))).length?s[s.length-1].beat:-1;var s;if(i>=0){const e=t-i;X.setTimeIndicatorPos(e)}const r=document.getElementById("timeindicator"),l=parseInt(r.max);e>l+100&&(e%=l,a(e)),r.value=e,requestAnimationFrame(o)};function a(e){P.port.postMessage({seek:e})}requestAnimationFrame(o),window.seek=a},window.mixerchange=function(e){P&&P.port.postMessage({midishortmsg:[176+e.detail.channel,e.detail.controller,e.detail.value]})},window.clearAll=async()=>{await C("Really delete everything?","")&&(oe(),document.querySelector("#postmixbutton").style.display="block",document.querySelector("#savebutton").style.display="block")},document.getElementById("tempoinput").addEventListener("change",(e=>{V=parseInt(e.target.value),ne()})),document.getElementById("addmidipartbutton").addEventListener("click",(async e=>{const t=await k(`\n        <h3>Select instrument</h3>\n        <p>\n        <select id="channelselect">\n            ${Y.map(((e,t)=>`<option value="${t}">${e}</option>`))}\n        </select>\n        </p>\n        <button onclick="getRootNode().result(-1)">Cancel</button>\n        <button onclick="getRootNode().result(parseInt(getRootNode().querySelector('#channelselect').value))">Ok</button>\n    `);t>=0&&(Q(t),ee(W.childNodes.length-1))})),G.addEventListener("change",(()=>ne()));const ae=document.getElementById("recordvideobutton");ae.addEventListener("click",(async()=>{B&&(ae.classList.contains("toggled")?(c.getVideoTracks().forEach((e=>e.stop())),l.stop(),d=null,ae.classList.remove("toggled")):(ae.classList.add("toggled"),await async function(e,t=null){try{const n=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!1});if(d=e.createMediaStreamDestination(),t?t.connect(d):e.createGain().connect(d),"true"===sessionStorage.getItem("capturemic")){const t=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),n=e.createMediaStreamSource(new MediaStream(t.getAudioTracks())),o=e.createGain();o.gain.value=.3,n.connect(o),o.connect(d)}const o=[...n.getVideoTracks(),...d.stream.getAudioTracks()];c=new MediaStream(o),l=new MediaRecorder(c),l.ondataavailable=e=>{if(e.data.size>0){var t=new Blob([e.data],{type:"video/webm"}),n=URL.createObjectURL(t),o=document.createElement("a");document.body.appendChild(o),o.style="display: none",o.href=n,o.download="test.webm",o.click(),window.URL.revokeObjectURL(n)}},l.start()}catch(e){console.error("Error: "+e)}}(B,P)))}));const ie=()=>{!async function(e,t){u(!0);const n=e[e.length-1].time/1e3,o=new OfflineAudioContext(2,44100*n,44100);await o.audioWorklet.addModule(F($)),await o.audioWorklet.addModule(F(O));const a=new AudioWorkletNode(o,"asc-midisynth-audio-worklet-processor",{outputChannelCount:[2]});a.port.start(),console.log("audioworklet node started");const i=new r(a.port);await i.callAndGetResult({samplerate:o.sampleRate,wasm:t,sequencedata:e,toggleSongPlay:!0},(e=>e.wasmloaded)),console.log("audioworklet node loaded"),a.connect(o.destination),console.log("rendering audio");let s=!0;const l=()=>requestAnimationFrame((()=>{_(o.currentTime/n),s?l():_(null)}));l();const c=await o.startRendering();console.log("finished rendering");const d=new Blob([R(c)],{type:"application/octet-stream"});s=!1,u(!1);const p=URL.createObjectURL(d),h=document.createElement("a");document.body.appendChild(h),h.style="display: none",h.href=p,h.download="exportedsong.wav",h.click(),window.URL.revokeObjectURL(p)}(document.querySelector("midi-mixer").getState().map(((e,t)=>[{time:0,message:[176+t,7,e.volume]},{time:0,message:[176+t,10,e.pan]}])).flat(1).concat(te()),K)};window.saveToLocalStorage=async()=>{localStorage.setItem("lastSavedMusicPiece",await b(q()))};const se=localStorage.getItem("lastSavedMusicPiece");se&&N(I(se));export{Q as addPianoroll,oe as clearAll,ie as exportWav,ee as selectPianoroll,ne as updateSequence};
        </script>
    </body>
</html>
